[gcode_macro _MOVE_FILAMENT]
gcode:
    {% set th = printer.toolhead %}
    {% set nozzle_temp = params.TEMPERATURE|float %}
    {% set distance = params.DISTANCE|default(50)|float %}
    {% set purge = params.PURGE|default(100)|float %}
    {% set speed = params.SPEED|default(300) %}
    {% set max_velocity = 60 * printer.configfile.settings['extruder'].max_extrude_only_velocity -1 %} ; convert from mm/s to mm/min
    SAVE_GCODE_STATE NAME=STATE_MOVE_FILAMENT

    {% if nozzle_temp >= 100 %}
      M117 Heating Nozzle...
      M104 S{nozzle_temp}
      _POS_SAFE_PURGE
      M109 S{nozzle_temp}
      
      M117 (Un)Loading Filament...
      M83 ; Relative Extruder
      {% if distance > 0 %}
        G1 E{distance} F{max_velocity}
        G1 E{purge} F{speed}
      {% else %}
        G1 E{purge} F{speed}
        G1 E{distance} F{max_velocity}
      {% endif %}
    {% else %}
      M117 Too low initial nozzle temperature: { nozzle_temp } < 100
      M118 Too low initial nozzle temperature: { nozzle_temp } < 100
    {% endif %}

    RESTORE_GCODE_STATE NAME=STATE_MOVE_FILAMENT

[gcode_macro LOAD_FILAMENT]
gcode:
    _MOVE_FILAMENT TEMPERATURE={params.TEMPERATURE} DISTANCE=70 PURGE=15 SPEED=600

[gcode_macro UNLOAD_FILAMENT]
gcode:
    _MOVE_FILAMENT TEMPERATURE={params.TEMPERATURE} DISTANCE=-130 PURGE=-15 SPEED=600
